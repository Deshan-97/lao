<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galaxy Lottery - Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #1a1a2e; color: #ffffff; font-family: Arial, sans-serif; }
    .admin-card { background: #16213e; border: 1px solid #0f4c75; }
    .btn-primary { background: #0f4c75; }
    .btn-primary:hover { background: #3282b8; }
    .btn-success { background: #27ae60; }
    .btn-success:hover { background: #2ecc71; }
    .btn-danger { background: #e74c3c; }
    .btn-danger:hover { background: #c0392b; }
  </style>
</head>
<body class="p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-8 text-center text-blue-400">Galaxy Lottery Admin Panel</h1>
    
    <!-- Winning Numbers Section -->
    <div class="admin-card p-6 rounded-lg mb-8">
      <h2 class="text-xl font-semibold mb-4">Set Winning Numbers</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm mb-2">Select 4 Winning Numbers (1-50):</label>
          <div id="admin-number-grid" class="grid grid-cols-10 gap-1 mb-4">
            <!-- Numbers generated by JS -->
          </div>
          <input type="date" id="draw-date" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white mb-4">
          <button id="set-winning-numbers" class="btn-primary text-white px-4 py-2 rounded hover:bg-blue-600 w-full">
            Set Winning Numbers
          </button>
        </div>
        <div>
          <h3 class="text-lg mb-3">Current Winning Numbers:</h3>
          <div id="current-winning" class="text-2xl mb-4">
            <span class="text-gray-400">No numbers set</span>
          </div>
          <button id="clear-winning-numbers" class="btn-danger text-white px-4 py-2 rounded hover:bg-red-600 w-full">
            Clear Winning Numbers
          </button>
        </div>
      </div>
    </div>

    <!-- Ticket Management Section -->
    <div class="admin-card p-6 rounded-lg">
      <h2 class="text-xl font-semibold mb-4">Ticket Management</h2>
      
      <!-- Filters -->
      <div class="mb-4 flex gap-4">
        <select id="status-filter" class="p-2 bg-gray-800 border border-gray-600 rounded text-white">
          <option value="">All Tickets</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="rejected">Rejected</option>
        </select>
        <button id="refresh-tickets" class="btn-primary text-white px-4 py-2 rounded hover:bg-blue-600">
          Refresh
        </button>
      </div>

      <!-- Tickets List -->
      <div id="tickets-list" class="space-y-3">
        <p class="text-gray-400 text-center">Loading tickets...</p>
      </div>
    </div>
  </div>

  <script>
    // Admin number selection for winning numbers
    const adminNumberGrid = document.getElementById('admin-number-grid');
    const selectedWinningNumbers = new Set();
    
    for (let i = 1; i <= 50; i++) {
      const btn = document.createElement('button');
      btn.className = 'bg-gray-700 text-white w-8 h-8 rounded text-sm hover:bg-gray-600';
      btn.textContent = i;
      btn.addEventListener('click', () => {
        if (selectedWinningNumbers.has(i)) {
          selectedWinningNumbers.delete(i);
          btn.classList.remove('bg-blue-600');
          btn.classList.add('bg-gray-700');
        } else if (selectedWinningNumbers.size < 4) {
          selectedWinningNumbers.add(i);
          btn.classList.remove('bg-gray-700');
          btn.classList.add('bg-blue-600');
        }
      });
      adminNumberGrid.appendChild(btn);
    }

    // Set winning numbers
    document.getElementById('set-winning-numbers').addEventListener('click', async () => {
      if (selectedWinningNumbers.size !== 4) {
        alert('Please select exactly 4 numbers');
        return;
      }
      
      const drawDate = document.getElementById('draw-date').value;
      if (!drawDate) {
        alert('Please select a draw date');
        return;
      }
      
      try {
        const response = await fetch('/api/winning-numbers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            numbers: [...selectedWinningNumbers].sort((a, b) => a - b),
            drawDate
          })
        });
        
        if (response.ok) {
          alert('Winning numbers set successfully!');
          loadCurrentWinningNumbers();
          selectedWinningNumbers.clear();
          document.querySelectorAll('#admin-number-grid button').forEach(btn => {
            btn.classList.remove('bg-blue-600');
            btn.classList.add('bg-gray-700');
          });
        } else {
          alert('Error setting winning numbers');
        }
      } catch (error) {
        alert('Network error');
      }
    });

    // Clear winning numbers
    document.getElementById('clear-winning-numbers').addEventListener('click', async () => {
      if (!confirm('Are you sure you want to clear the current winning numbers?')) {
        return;
      }
      
      try {
        const response = await fetch('/api/winning-numbers/clear', {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('Winning numbers cleared successfully!');
          loadCurrentWinningNumbers();
        } else {
          alert('Error clearing winning numbers');
        }
      } catch (error) {
        alert('Network error');
      }
    });

    // Load current winning numbers
    async function loadCurrentWinningNumbers() {
      try {
        const response = await fetch('/api/winning-numbers/latest');
        const data = await response.json();
        
        const currentDiv = document.getElementById('current-winning');
        if (data && data.numbers) {
          currentDiv.innerHTML = data.numbers.map(num => 
            `<span class="bg-purple-600 px-3 py-1 rounded-full mr-2">${num}</span>`
          ).join('');
        } else {
          currentDiv.innerHTML = '<span class="text-gray-400">No numbers set</span>';
        }
      } catch (error) {
        console.error('Error loading winning numbers');
      }
    }

    // Load tickets
    async function loadTickets(status = '') {
      try {
        const url = status ? `/api/tickets?status=${status}` : '/api/tickets';
        const response = await fetch(url);
        const tickets = await response.json();
        
        const ticketsDiv = document.getElementById('tickets-list');
        
        if (tickets.length === 0) {
          ticketsDiv.innerHTML = '<p class="text-gray-400 text-center">No tickets found</p>';
          return;
        }
        
        ticketsDiv.innerHTML = tickets.map(ticket => {
          const statusColor = ticket.status === 'confirmed' ? 'bg-green-600' : 
                             ticket.status === 'rejected' ? 'bg-red-600' : 'bg-yellow-600';
          
          return `
            <div class="bg-gray-800 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <p class="font-semibold">Ticket ID: ${ticket.id}</p>
                  <p class="text-sm text-gray-300">Phone: ${ticket.user_phone}</p>
                  <p class="text-sm">Numbers: ${ticket.selected_numbers.join(', ')}</p>
                  <p class="text-xs text-gray-400">Purchased: ${new Date(ticket.purchase_date).toLocaleDateString()}</p>
                </div>
                <span class="px-3 py-1 rounded text-sm ${statusColor}">${ticket.status}</span>
              </div>
              
              ${ticket.receipt_image ? `
                <div class="mb-3">
                  <img src="${ticket.receipt_image}" alt="Receipt" class="max-w-xs max-h-32 object-contain border rounded">
                </div>
              ` : ''}
              
              ${ticket.status === 'pending' ? `
                <div class="flex gap-2">
                  <button onclick="confirmTicket(${ticket.id})" 
                          class="btn-success text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                    Confirm
                  </button>
                  <button onclick="rejectTicket(${ticket.id})" 
                          class="btn-danger text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                    Reject
                  </button>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        document.getElementById('tickets-list').innerHTML = '<p class="text-red-400 text-center">Error loading tickets</p>';
      }
    }

    // Confirm ticket
    async function confirmTicket(id) {
      try {
        const response = await fetch(`/api/tickets/${id}/confirm`, { method: 'PUT' });
        if (response.ok) {
          alert('Ticket confirmed!');
          loadTickets(document.getElementById('status-filter').value);
        } else {
          alert('Error confirming ticket');
        }
      } catch (error) {
        alert('Network error');
      }
    }

    // Reject ticket
    async function rejectTicket(id) {
      try {
        const response = await fetch(`/api/tickets/${id}/reject`, { method: 'PUT' });
        if (response.ok) {
          alert('Ticket rejected!');
          loadTickets(document.getElementById('status-filter').value);
        } else {
          alert('Error rejecting ticket');
        }
      } catch (error) {
        alert('Network error');
      }
    }

    // Event listeners
    document.getElementById('status-filter').addEventListener('change', (e) => {
      loadTickets(e.target.value);
    });

    document.getElementById('refresh-tickets').addEventListener('click', () => {
      loadTickets(document.getElementById('status-filter').value);
    });

    // Initialize
    loadCurrentWinningNumbers();
    loadTickets();
    
    // Set default date to today
    document.getElementById('draw-date').valueAsDate = new Date();
  </script>
</body>
</html> 